version: 0.0.1.{build}
configuration: Release
platform: All
image: Visual Studio 2017
environment:
  python: C:\Python36-x64\python.exe
  pip: C:\Python36-x64\Scripts\pip
  makensis: C:\PROGRA~2\NSIS\makensis.exe
  TCL_LIBRARY: C:\Python36-x64\tcl\tcl8.6
  TK_LIBRARY: C:\Python36-x64\tcl\tk8.6
branches:
  only:
  - master
skip_tags: true
# init:
 # - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
install:
  - "%python% --version"
build_script:
  - set /p release_version=<version
  - set release_version=%release_version:~0,32%
  - git clone https://github.com/Scille/parsec-cloud.git
  - cd parsec-cloud
  - git fetch
  - git checkout %release_version%
  - echo __version__ = "%release_version%" >> parsec/_version.py
  - "%pip% install .[core,backend] --process-dependency-links"
  - "%pip% install cx_freeze idna"
  - cp ..\parsec.py parsec
  - cp ..\favicon.ico .
  - powershell -Command "(gc setup.py) -creplace 'parsec/cli.py', 'parsec/parsec.py' | Out-File setup.py -Encoding ascii"
  - powershell -Command "(gc setup.py) -creplace 'targetName=\"parsec\"', 'targetName=\"parsec.exe\", base=\"Win32GUI\", icon=\"../favicon.ico\"' | Out-File setup.py -Encoding ascii"
  - "%python% setup.py build"
  - cd ..
  - move parsec-cloud\build\exe.win-amd64-3.6 build
  - cp build\lib\PyQt5\Qt\bin\vcruntime140.dll build
  - "%makensis% parsec.nsi"
  - powershell -Command "(gc choco\parsec.nuspec) -creplace 'VERSION', '%release_version:~1%' | Out-File choco\parsec.nuspec"
  - powershell -Command "(gc choco\tools\chocolateyinstall.ps1) -creplace 'VERSION', '%release_version%' | Out-File choco\tools\chocolateyinstall.ps1"
  - powershell -Command "(gc choco\tools\chocolateyinstall.ps1) -creplace 'CHECKSUM', (get-filehash Parsec_setup.exe).hash | Out-File choco\tools\chocolateyinstall.ps1"
  - "rename Parsec_setup.exe parsec_%release_version%_amd64.exe"
  - cd choco
  - choco pack || exit 0
  - set original_release_version=%release_version%
  - set release_version=%release_version:~1%
test: off
artifacts:
  - path: "parsec_%original_release_version%_amd64.exe"
    name: installer
  - path: "choco/parsec-cloud.%release_version%.nupkg"
    name: choco_package
deploy:
  - provider: GitHub
    release: "%original_release_version%"
    auth_token:
      secure: lyNNIFX5PY8L2IxvWOp+dbc+oCXJ0dkc7jgqgc4BVfAT5RyeP6kalg/08dbKzOuU
    artifact: installer
    draft: false
  - provider: NuGet
    server: https://push.chocolatey.org/
    api_key:
      secure: OSr40DIKsX+IDfOyP6H7pAk8tXVVrfUSNzKRL1tXhOa/vZvG+a5tsbgPJyLYE6Ot
    skip_symbols: true
    artifact: choco_package
# on_finish:
 # - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
