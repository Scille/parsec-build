language: python
python:
- '3.6'
install:
- locale-gen en_US.UTF-8
- export LANG="en_US.UTF-8"
- export LANGUAGE="en_US:en"
- export LC_ALL="en_US.UTF-8"
- sudo apt-get update
- sudo apt-get install build-essential software-properties-common -y
- sudo add-apt-repository ppa:jonathonf/python-3.6 -y
- sudo apt-get update
- sudo apt-get install python3.6 python3-pip -y
- sudo apt-get install git -y
- git clone https://github.com/Scille/parsec-build.git
- cd parsec-build
- git submodule update --init --recursive
- pip3 install virtualenv
- virtualenv venv -p python3.6
- source venv/bin/activate
- sudo apt-get install debhelper python3.6-dev python3-pytest libssl-dev -y
- sudo apt-add-repository ppa:dh-virtualenv/daily -y
- sudo apt-get update
- sudo apt-get install dh-virtualenv libpq-dev libffi-dev fakeroot -y
- sudo curl -o /usr/local/bin/n https://raw.githubusercontent.com/visionmedia/n/master/bin/n
- sudo chmod +x /usr/local/bin/n
- sudo n stable
script:
- cd parsec-cloud
- make deb
- cd ../parsec-gui
- npm install
- npm run electron:deb
- cd ..
- mkdir build
- cd build
- cp ../parsec-cloud*.deb .
- cp ../parsec-gui/dist/installers/parsec-gui*.deb .
- mkdir parsec-cloud parsec-gui
- dpkg-deb -R parsec-cloud_0.1-1_amd64.deb parsec-cloud
- dpkg-deb -R parsec-gui_0.1.0_amd64.deb parsec-gui
- rsync -a parsec-gui/usr/ parsec-cloud/usr/
- ln -s /usr/share/python/parsec-cloud/bin/parsec parsec-cloud/usr/bin/parsec
- mv parsec-cloud/usr/bin/parsec-gui parsec-cloud/usr/bin/parsec-electron
- echo '#!/usr/bin/env sh' >> parsec-cloud/usr/bin/parsec-gui
- echo 'parsec core -W 30 -H wss://parsec-cloud.herokuapp.com --debug &' >> parsec-cloud/usr/bin/parsec-gui
- echo 'sleep 1' >> parsec-cloud/usr/bin/parsec-gui
- echo 'core_pid=$!' >> parsec-cloud/usr/bin/parsec-gui
- echo 'parsec-electron' >> parsec-cloud/usr/bin/parsec-gui
- echo 'kill $core_pid' >> parsec-cloud/usr/bin/parsec-gui
- chmod +x parsec-cloud/usr/bin/parsec-gui
- depends_line=`grep "Depends:" parsec-gui/DEBIAN/control`
- sed -i "7i $depends_line" parsec-cloud/DEBIAN/control
- cloud_size=`grep "Installed-Size:" parsec-cloud/DEBIAN/control | cut -f 2 -d " "`
- gui_size=`grep "Installed-Size:" parsec-gui/DEBIAN/control | cut -f 2 -d " "`
- total_size=$((cloud_size + gui_size))
- sed -i -- "s/$cloud_size/$total_size/g" parsec-cloud/DEBIAN/control
- dpkg-deb -b parsec-cloud parsec_amd64.deb
deploy:
  provider: releases
  api_key:
    secure: Ht/Toq2UyMtd+4Eji4x1XpLfdXKYZ0CD8RGdacPoTeMht/U24kYUE+fr0i7vEgbzrzpeDJUjKzhMZC1WNYBDEdA0GAbQsNYoGuAA1AWf5N6OOAs1E26viI6sbg/xplGfaFEBk0lRONCtDVnDGyFP45E9TeG6A92DPGNJw0l66HObhOIKNPXwh06g2/iFsJUXu6F6Xrwen5drFZ0H2IxtTF5y0297rv4P9qhXvNoorYhH4zcI8maGeYBnl6uj2jFu2AzwvWWl7UjMrFjWI6RAVs/lhBOkgsxaYIVKqJiUNtKdfzItmqJgB4HDy7OignPY60dC1/fPEtDdRVC5JwejQnvE5sk1YllRe3E8d46qTIIYzJHZ7kuWgW3Lj6Pnowzzn8FNfLTgOX5EviZG07KY92kSay15Jyfnhtuc7HAeNhxlsko1LFWRTyXWawPr4x725OG3dSlmA+xO1zDyyPIwiGBxNmfZlvYqhk71O++vby9Jpcjdy8c/0coxL/Xg2SmD9NDosE5TpavFLDi3dQiKyZdq6P8B7nOzmBI2SsMPWA86xdT0b8oufnuCL9mahbw74lSC8nuAXcaLr8kvzwWN1pcQ1HOArD+xu9zWixvFabDK1s+B5/maKtw0yxGMCmC2uDq+DD3NklJ4/ekBk2xA63iEmg24JfJSpwcXCUm9jIY=
  file: parsec_amd64.deb
  skip_cleanup: true
  on:
    repo: Scille/parsec-build
